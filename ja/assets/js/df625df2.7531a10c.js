"use strict";(self.webpackChunkpaima_engine_docs=self.webpackChunkpaima_engine_docs||[]).push([[2534],{7077:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>d,frontMatter:()=>a,metadata:()=>o,toc:()=>l});var t=i(5893),s=i(1151);const a={},r="Paima Batcher",o={id:"home/setup/paima-bacher",title:"Paima Batcher",description:"Paima Batcher is the first key component of the Paima Whirlpool infrastructure which enables cross-chain play (via account abstraction layer), automatically paying transaction fees for users, and decreasing overall fees by batching many game inputs together.",source:"@site/docs/home/1-setup/20-paima-bacher.md",sourceDirName:"home/1-setup",slug:"/home/setup/paima-bacher",permalink:"/ja/home/setup/paima-bacher",draft:!1,unlisted:!1,editUrl:"https://github.com/PaimaStudios/paima-engine-docs/tree/main/docs/home/1-setup/20-paima-bacher.md",tags:[],version:"current",sidebarPosition:20,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Connect Wallet To Test",permalink:"/ja/home/setup/connecting-wallets"},next:{title:"Contract Configurations",permalink:"/ja/home/smart-contracts/evm/introduction"}},c={},l=[{value:"Benefits",id:"benefits",level:2},{value:"Preparation",id:"preparation",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Common settings",id:"common-settings",level:3},{value:"Required settings",id:"required-settings",level:4},{value:"Optional settings",id:"optional-settings",level:4},{value:"Network dependent settings",id:"network-dependent-settings",level:3},{value:"Evm",id:"evm",level:4},{value:"Required settings",id:"required-settings-1",level:5},{value:"Optional settings",id:"optional-settings-1",level:5},{value:"Avail",id:"avail",level:4},{value:"Required",id:"required",level:5},{value:"Usage",id:"usage",level:2},{value:"Cleanup",id:"cleanup",level:2},{value:"Batcher Security (reCAPTCHA)",id:"batcher-security-recaptcha",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",h5:"h5",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"paima-batcher",children:"Paima Batcher"}),"\n",(0,t.jsx)(n.p,{children:"Paima Batcher is the first key component of the Paima Whirlpool infrastructure which enables cross-chain play (via account abstraction layer), automatically paying transaction fees for users, and decreasing overall fees by batching many game inputs together."}),"\n",(0,t.jsx)(n.p,{children:"For background, Paima Engine-based games rely on user inputs being posted to a Paima L2 Contract, which, by default, requires users to send transactions to the target blockchain. This approach has the disadvantage of limiting input posters to using accounts and funds solely on the target blockchain."}),"\n",(0,t.jsx)(n.p,{children:"Paima Batcher overcomes this by accepting game inputs signed by various wallets, batches them into a new transaction, and posts them all at once to the deployed Paima L2 Contract. This allows the game inputs to be processed by your game node as if they were posted by the original users directly."}),"\n",(0,t.jsx)(n.p,{children:'Before submitting the inputs, the batcher always verifies the attached signature to ensure that invalid signatures do not get posted (Paima Funnel inside of the Engine also does this check, but this acts as an extra proactive measure). Additionally, you can configure the batcher to impose limits on how often a given address can submit game inputs in a given timeframe, or even configure the batcher to validate the game inputs themselves and reject any that it finds to be invalid (in order to avoid wasting transaction fees, and prevent "DoS" attacks by bad actors).'}),"\n",(0,t.jsx)(n.p,{children:"Furthermore, batcher support is fully integrated into Paima Engine, including the middleware core in Paima SDK, so there is no need to worry about writing extra code to make your game work with the batcher. It just seamlessly works."}),"\n",(0,t.jsx)(n.p,{children:"Of note, because Paima Engine games are full fledged Sovereign Rollups, this means we have a built-in mechanism for democratization & decentralization of batching (unlike the majority of rollups today). In other words, anyone can run a batcher for any game built with Paima Engine, opening up opportunities for your community & 3rd party developers to create their own web/mobile game clients, tools, websites, and services that provide players with completely novel gameplay experiences!"}),"\n",(0,t.jsxs)(n.p,{children:["You can learn more about the architecture of the batcher ",(0,t.jsx)(n.a,{href:"/ja/home/state-machine/direct-write/batched-mode",children:"here"})]}),"\n",(0,t.jsx)(n.h2,{id:"benefits",children:"Benefits"}),"\n",(0,t.jsx)(n.p,{children:"Game input batching provides us with a few major benefits, primarily in the realm of UX:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"We get some scaling/efficiency benefits in regards to on-chain processing."}),"\n",(0,t.jsx)(n.li,{children:"We can allow users on mobile to merely generate a new keypair without owning any crypto, pay the batcher via in-app purchases, and play the games."}),"\n",(0,t.jsx)(n.li,{children:'We can build "bridges" on any L1 blockchain (ex. Ethereum, Cardano, Algorand, Solana, ...) where users pay the bridge (on-chain) to have the ability to use the batcher (off-chain) to submit their game input for them.'}),"\n",(0,t.jsx)(n.li,{children:"We can subsidize users who meet certain requirements to play for free (ex. they own a Paima NFT)"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"preparation",children:"Preparation"}),"\n",(0,t.jsx)(n.p,{children:"To begin using Paima Batcher, first you will need to emit it from the Paima Engine executable. Simply call:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"./paima-engine batcher\n"})}),"\n",(0,t.jsxs)(n.p,{children:["This will pop out a ",(0,t.jsx)(n.code,{children:"batcher"})," folder with all of the Paima Batcher code inside for you to build/deploy, and you can then change into the ",(0,t.jsx)(n.code,{children:"batcher"})," directory using"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cd batcher\n"})}),"\n",(0,t.jsx)(n.p,{children:"With that out of the way, we can move forward with deploying the batcher. In summary, you need to:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Prepare your root ",(0,t.jsx)(n.code,{children:".env.*"})," config file to support the batcher,"]}),"\n",(0,t.jsx)(n.li,{children:"Add your batcher wallet account private key to it,"}),"\n",(0,t.jsxs)(n.li,{children:["Run the batcher using ",(0,t.jsx)(n.code,{children:"./start.sh"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["First, ensure you have a config file ",(0,t.jsx)(n.code,{children:".env.*"})," ready in the root directory of your project (where you called ",(0,t.jsx)(n.code,{children:"./paima-engine batcher"}),"). Presumably, you already have one there for your game, you just need to add the additional variables required by the batcher. The simplest approach to do this is to append the existing batcher env file into your env file in the directory above:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"cat .env.mainnet >> ../.env.mainnet\n"})}),"\n",(0,t.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsxs)(n.p,{children:["Many of the environment variables used by the batcher are shared with the\nengine, and these are already documented ",(0,t.jsx)(n.a,{href:"/ja/home/setup/environment-config-values",children:"here"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"common-settings",children:"Common settings"}),"\n",(0,t.jsx)(n.p,{children:"The batcher supports submitting transactions to more than one network.  This\nsection talks about settings that apply in both cases, and then follow the\nspecific ones."}),"\n",(0,t.jsx)(n.h4,{id:"required-settings",children:"Required settings"}),"\n",(0,t.jsxs)(n.p,{children:["Of note, one key variable that needs to be set manually to use the batcher is\nthe ",(0,t.jsx)(n.code,{children:"BATCHER_PRIVATE_KEY"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["For evm based chains this needs to be set as the\nprivate key of the wallet intended to be used for creating and posting the\nbatched transactions (note, the wallet needs sufficient funds for posting to the\ncontract). The expected format of the variable is a hex string without the ",(0,t.jsx)(n.code,{children:"0x"}),"\nprefix (ie. exactly what you get from MetaMask under Account details -> Export\nprivate key)."]}),"\n",(0,t.jsxs)(n.p,{children:["For Avail the format is that of a ",(0,t.jsx)(n.a,{href:"https://polkadot.js.org/docs/keyring/start/suri/",children:"Substrate\nuri"}),".  Note this is only used\nfor self signed inputs, otherwise it's handled by the light client."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"CHAIN_URI"}),": The URI of the chain (rpc endpoint)."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"BATCHER_PORT"}),": The port to listen for submissions from the frontend."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"BATCHER_DB_HOST"}),": Host of the batcher's database."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"BATCHER_DB_USER"}),": User for the batcher's database."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"BATCHER_DB_PW"}),": Password for the batcher's database."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"BATCHER_DB_NAME"}),": Name of the database."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"ENABLE_RECAPTCHA_V3"}),": See ",(0,t.jsx)(n.a,{href:"#batcher-security-recaptcha",children:"this section"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"RECAPTCHA_V3_BACKEND"}),": See ",(0,t.jsx)(n.a,{href:"#batcher-security-recaptcha",children:"this section"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"BATCHED_MESSAGE_SIZE_LIMIT"}),": Max size limit (in characters) for batched\ntransactions in a single round."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"MAX_USER_INPUTS_PER_MINUTE"}),": Per user input submission limit."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"MAX_USER_INPUTS_PER_DAY"}),": Per user input submission limit."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"SECURITY_NAMESPACE"}),": ",(0,t.jsx)(n.a,{href:"/ja/home/state-machine/direct-write/autosign#defining-your-namespace",children:"See this section for details"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"optional-settings",children:"Optional settings"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"BATCHED_TRANSACTION_POSTER_PERIOD"}),": Delay for the transaction poster loop\nwhen there are no inputs in the queue."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"GAME_NODE_URI"}),": Used for input validation."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"DEFAULT_VALIDATION_ACTIVE"}),": Whether input validation is active or not. This\nrequires ",(0,t.jsx)(n.code,{children:"GAME_NODE_URI"})," to also be set."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"GAME_INPUT_VALIDATOR_PERIOD"}),": Throttle for the input validator."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["If you plan to use the batcher in web 2.5 environment, you also need to turn on the self signing feature by setting ",(0,t.jsx)(n.code,{children:'SELF_SIGNING_ENABLED="true"'})," and filling in ",(0,t.jsx)(n.code,{children:"API_KEY"})," value of your choice in ",(0,t.jsx)(n.code,{children:"SELF_SIGNING_API_KEY"})," variable. You'll use this key afterwards on the server communicating with the batcher."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"BATCHER_CARDANO_ENABLED_POOLS"}),": A comma separated list of pool credentials,\nonly users delegating to one of these pools will be able to post to the batcher.\nThe expected format is the public key hash (28 bytes) as a hexadecimal string\n(56 characters)."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"CARP_URL"}),": The URL of a Carp instance. This is required if\n",(0,t.jsx)(n.code,{children:"BATCHER_CARDANO_ENABLED_POOLS"})," is used."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"network-dependent-settings",children:"Network dependent settings"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"BATCHER_NETWORK"})," can be used to choose the type of network the batcher submits\nto. Possible values are: ",(0,t.jsx)(n.code,{children:"evm"})," and ",(0,t.jsx)(n.code,{children:"avail"}),". If not set it will default to ",(0,t.jsx)(n.code,{children:"evm"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"evm",children:"Evm"}),"\n",(0,t.jsx)(n.h5,{id:"required-settings-1",children:"Required settings"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"CONTRACT_ADDRESS"}),": The address of your Paima L2 contract."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"DEFAULT_FEE"}),": The fee for the contract call."]}),"\n"]}),"\n",(0,t.jsx)(n.h5,{id:"optional-settings-1",children:"Optional settings"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"MAX_BASE_GAS"}),": For gas estimation. Defaults to 50000."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"MAX_GAS_PER_BYTE"}),": For gas estimation: Defaults to 32."]}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"avail",children:"Avail"}),"\n",(0,t.jsx)(n.h5,{id:"required",children:"Required"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"BATCHER_AVAIL_LIGHT_CLIENT"}),": for the Avail's light client rest api. This is\nused for the transaction poster. ",(0,t.jsx)(n.a,{href:"https://docs.availproject.org/docs/operate-a-node/run-a-light-client/light-client-api-reference#v2submit",children:"Reference"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"SECURITY_NAMESPACE"}),": There is no contract address in this case, so this is\nrequired in this case. ",(0,t.jsx)(n.a,{href:"/ja/home/state-machine/direct-write/autosign#defining-your-namespace",children:"See this section for\ndetails"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,t.jsxs)(n.p,{children:["With all of that said and done, to compile and run the batcher using docker simply run the following in the ",(0,t.jsx)(n.code,{children:"batcher"})," directory:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sh ./start.sh\n"})}),"\n",(0,t.jsx)(n.p,{children:"If your env file was set up properly, it will boot the batcher up and have it ready to be used with your game."}),"\n",(0,t.jsxs)(n.p,{children:["Of note, the IP/port (or domain name) that the batcher is running/accessible on will need to be copied and set as the ",(0,t.jsx)(n.code,{children:"BATCHER_URI"})," in your env file. This variable is used by the middleware to allow the game frontend/wallet to seamlessly integrate with the batcher without any extra work on your end."]}),"\n",(0,t.jsx)(n.h2,{id:"cleanup",children:"Cleanup"}),"\n",(0,t.jsx)(n.p,{children:"At any point after stopping the batcher, you can clean up via the following command:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sh ./shutdown.sh\n"})}),"\n",(0,t.jsx)(n.h2,{id:"batcher-security-recaptcha",children:"Batcher Security (reCAPTCHA)"}),"\n",(0,t.jsx)(n.p,{children:"As the Paima Batcher posts user submissions, you might want only to allow human users to submit data and avoid bots or malicious agents. This is a difficult task, but Paima Batcher can leverage Google's reCAPTCHA V3 and easily be integrated into games."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Create a reCAPTCHA V3 account and get the ",(0,t.jsx)(n.code,{children:"site-key"})," and ",(0,t.jsx)(n.code,{children:"secret-key"}),". (",(0,t.jsx)(n.a,{href:"https://www.google.com/recaptcha",children:"https://www.google.com/recaptcha"}),")"]}),"\n"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Set ",(0,t.jsx)(n.code,{children:"RECAPTCHA_V3_BACKEND"})," in the ",(0,t.jsx)(n.code,{children:".env.<NETWORK>"})," file with your ",(0,t.jsx)(n.code,{children:"secret-key"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Set ",(0,t.jsx)(n.code,{children:"RECAPTCHA_V3_FRONTEND"})," in the ",(0,t.jsx)(n.code,{children:".env.<NETWORK>"})," file with your ",(0,t.jsx)(n.code,{children:"site-key"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Set ",(0,t.jsx)(n.code,{children:"ENABLE_RECAPTCHA_V3"})," in the ",(0,t.jsx)(n.code,{children:".env.<NETWORK>"})," file as ",(0,t.jsx)(n.code,{children:"'true'"})," If this value is unset, then only a valid recaptcha key is required, but no check is done to validate if the user is human."]}),"\n",(0,t.jsxs)(n.li,{children:["(OPTIONAL) Set ",(0,t.jsx)(n.code,{children:"RECAPTCHA_V3_SCORE"})," in the ",(0,t.jsx)(n.code,{children:".env.<NETWORK>"})," file as a value between ",(0,t.jsx)(n.code,{children:"0.0"})," and ",(0,t.jsx)(n.code,{children:"1.0"})," (default ",(0,t.jsx)(n.code,{children:"0.5"})," is used if not set). reCAPTCHA V3 returns a value between 0.0 and 1.0, where 0.0 is most likely a bot, and 1.0 is most likely a human. Scores < RECAPTCHA_V3_SCORE will be rejected."]}),"\n"]}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsx)(n.li,{children:"Add the reCAPTCHA code to your project"}),"\n"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Add the reCaptcha3 script ",(0,t.jsx)(n.code,{children:'<script src="https://www.google.com/recaptcha/api.js?render=${site_key}" />'})," into your main HTML."]}),"\n",(0,t.jsxs)(n.li,{children:["Or call ",(0,t.jsx)(n.code,{children:"injectReCaptchaToHTML()"})," in your frontend through the middleware."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["NOTE: By default reCAPTCHA actions will be labeled ",(0,t.jsx)(n.code,{children:"submit/{key}"})," where ",(0,t.jsx)(n.code,{children:"key"})," is the prefix of the concise command, e.g., ",(0,t.jsx)(n.code,{children:"@j|10|0x9134|z"})," will be named ",(0,t.jsx)(n.code,{children:"submit/j"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"import { ENV, injectReCaptchaToHTML } from '@paima/sdk/utils';\n\nif (ENV.RECAPTCHA_V3_FRONTEND) {\n  // highlight-next-line\n  injectReCaptchaToHTML().then(() => {\n    console.log('ReCaptcha loaded');\n  });\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"Once enabled all batcher calls will be validated and reject calls if no token or non-human activity is detected."})]})}function d(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},1151:(e,n,i)=>{i.d(n,{Z:()=>o,a:()=>r});var t=i(7294);const s={},a=t.createContext(s);function r(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);