"use strict";(self.webpackChunkpaima_engine_docs=self.webpackChunkpaima_engine_docs||[]).push([[664],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=c(n),h=r,m=d["".concat(l,".").concat(h)]||d[h]||p[h]||i;return n?a.createElement(m,o(o({ref:t},u),{},{components:n})):a.createElement(m,o({ref:t},u))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var c=2;c<i;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},3547:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var a=n(7462),r=(n(7294),n(3905));const i={},o="Paima Funnel",s={unversionedId:"home/Reacting to Events/Funnel Types/Intro",id:"home/Reacting to Events/Funnel Types/Intro",title:"Paima Funnel",description:"A core library which allows a consumer to initialize a chain funnel object which holds state regarding:",source:"@site/docs/home/3 - Reacting to Events/3 - Funnel Types/1 - Intro.md",sourceDirName:"home/3 - Reacting to Events/3 - Funnel Types",slug:"/home/Reacting to Events/Funnel Types/Intro",permalink:"/ja/home/Reacting to Events/Funnel Types/Intro",draft:!1,editUrl:"https://github.com/PaimaStudios/paima-engine-docs/docs/home/3 - Reacting to Events/3 - Funnel Types/1 - Intro.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Generic CDE",permalink:"/ja/home/Reacting to Events/Chain Data Extensions/Generic"},next:{title:"Block Funnel",permalink:"/ja/home/Reacting to Events/Funnel Types/Block Funnel"}},l={},c=[{value:"readData function",id:"readdata-function",level:2},{value:"readPresyncData function",id:"readpresyncdata-function",level:2},{value:"getDbTx",id:"getdbtx",level:2}],u={toc:c};function p(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"paima-funnel"},"Paima Funnel"),(0,r.kt)("p",null,"A core library which allows a consumer to initialize a chain funnel object which holds state regarding:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The blockchain node (",(0,r.kt)("inlineCode",{parentName:"li"},"CHAIN_URI"),")"),(0,r.kt)("li",{parentName:"ul"},"The deployed Paima Contract address (",(0,r.kt)("inlineCode",{parentName:"li"},"CONTRACT_ADDRESS"),")"),(0,r.kt)("li",{parentName:"ul"},"The set of ",(0,r.kt)("a",{parentName:"li",href:"/ja/home/Reacting%20to%20Events/Chain%20Data%20Extensions/introduction"},"Chain Data Extension (CDEs)")," that the developer provided")),(0,r.kt)("p",null,"Notably, funnels play a key role in allowing Paima to not just synchronize a single chain, but also combine multiple different data sources together such as DA layers, merging L1+L2 data together, or merging NFT data from different chains."),(0,r.kt)("p",null,"All Paima Funnels implement a simple interface:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"interface ChainFunnel {\n  readData: (blockHeight: number) => Promise<ChainData[]>;\n  readPresyncData: (fromBlock: number, toBlock: number) => Promise<PresyncChainData[]>;\n  getDbTx(): PoolClient;\n}\n")),(0,r.kt)("p",null,"Funnels are meant to be stateless between blocks to avoid subtle bugs in the case of errors during the sync process (so that state properly gets reset), as well as to encapsulate the fact that funnels are executed together in a joint SQL transaction. Funnels that need state should use:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"For persistent storage, use the Paima SQL database. This can be use to hydrate the funnel type using a custom-defined ",(0,r.kt)("inlineCode",{parentName:"li"},"recoverState"),". If used, you should NOT assume that data for your funnel being persisted in the database implies the game state machine will successfully be updated. Fetching data (funnels) and update the game machine are done in separate SQL transactions (so it's possible fetching data succeeds, but updating the game fails so re-fetching the data is required)"),(0,r.kt)("li",{parentName:"ul"},"A custom cache entry in ",(0,r.kt)("inlineCode",{parentName:"li"},"FunnelCacheManager")," for state that either needs to be persisted (ex: query a batch of data that gets processed across multiple blocks) or that needs to be shared between funnels")),(0,r.kt)("p",null,"Multiple funnels are combined together based on the developer's needs using a combination of the ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Composite_pattern"},"composite pattern")," and the ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Decorator_pattern"},"decorator pattern"),", allowing to mix-and-match funnel types depending on the game's setup to get all the data they need."),(0,r.kt)("h2",{id:"readdata-function"},"readData function"),(0,r.kt)("p",null,"At its core, Paima will call the ",(0,r.kt)("inlineCode",{parentName:"p"},"readData")," function according to ",(0,r.kt)("inlineCode",{parentName:"p"},"POLLING_RATE")," (which by default is based on ",(0,r.kt)("inlineCode",{parentName:"p"},"BLOCK_TIME"),"), and pass in the next expected block height (based off what is stored on disk by the Paima state machine)."),(0,r.kt)("p",null,"Paima funnel is in charge of filling the ",(0,r.kt)("inlineCode",{parentName:"p"},"ChainData")," which represents the combined output of all the different funnels for a block. Its type is as follows"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-typescript"},"export interface ChainData {\n  timestamp: number;\n  blockHash: string;\n  blockNumber: number;\n  submittedData: SubmittedData[];\n  extensionDatums?: ChainDataExtensionDatum[];\n}\n")),(0,r.kt)("h2",{id:"readpresyncdata-function"},"readPresyncData function"),(0,r.kt)("p",null,"When extensions are used, the runtime must start polling from a block height that was before any of the contracts referenced in the CDEs were deployed. Thus all events that take place (ie. all NFT mints/transfer events) are accounted for and are saved in the DB so the state machine has proper access to a valid copy of the current state of the contract. We call this the ",(0,r.kt)("em",{parentName:"p"},"pre-sync")," phase."),(0,r.kt)("p",null,"In other words, this function is meant to gather events for ",(0,r.kt)("a",{parentName:"p",href:"/ja/home/Reacting%20to%20Events/Chain%20Data%20Extensions/introduction#accessing-the-collected-data"},"CDEs")," that happened before ",(0,r.kt)("inlineCode",{parentName:"p"},"START_BLOCKHEIGHT")),(0,r.kt)("h2",{id:"getdbtx"},"getDbTx"),(0,r.kt)("p",null,"Gets the database transaction used when executing this funnel"))}p.isMDXComponent=!0}}]);